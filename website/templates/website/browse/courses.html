{% extends "website/base.html" %}
{% block title %}Courses{% endblock %}

{% block content %}
<section class="browse-section">
  <div class="container">

    <div class="d-flex justify-content-between align-items-center">
      <h1 id="pageTitle" class="browse-title">Courses</h1>

      <!-- Admin Only -->
      <button id="addCourseBtn"
              class="btn btn-primary d-none">
        ➕ Add Course
      </button>
    </div>

    <p class="browse-subtitle">Select your course</p>

    <!-- Search -->
    <div class="row mt-4">
      <div class="col-md-6">
        <input type="text"
               id="searchInput"
               class="form-control"
               placeholder="Search courses...">
      </div>
    </div>

    <!-- Loader -->
    <div id="loader" class="text-center my-5">
      <div class="spinner-border text-primary"></div>
    </div>

    <!-- Grid -->
    <div id="coursesGrid"
         class="row g-4 mt-4 d-none"></div>

    <!-- Pagination -->
    <nav class="mt-4">
      <ul class="pagination justify-content-center"
          id="pagination"></ul>
    </nav>

  </div>
</section>

<!-- ================= MODAL ================= -->
<div class="modal fade" id="courseModal">
  <div class="modal-dialog">
    <div class="modal-content p-4">

      <h5 id="modalTitle">Add Course</h5>

      <input id="courseName"
             class="form-control my-2"
             placeholder="Course name">

      <select id="curriculumType"
              class="form-control my-2">
        <option value="semester">Semester</option>
        <option value="year">Year</option>
      </select>

      <input id="duration"
             type="number"
             class="form-control my-2"
             placeholder="Duration (e.g. 3, 4, 6)">

      <select id="durationUnit"
              class="form-control my-2">
        <option value="year">Year</option>
        <option value="semester">Semester</option>
      </select>

      <div class="text-end mt-3">
        <button class="btn btn-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button id="saveCourseBtn"
                class="btn btn-primary">
          Save
        </button>
      </div>

    </div>
  </div>
</div>

<script>
(function () {

  if (!window.location.pathname.includes("courses")) return;

  //const API_BASE = "http://127.0.0.1:8000/api/courses/";
  const API_BASE = "https://education-backend-2-qmvp.onrender.com/api/courses/";
  const token = localStorage.getItem("access_token");
  const isAdmin = localStorage.getItem("is_admin");

  if (!token) {
    window.location.href = "/login/";
    return;
  }

  const params = new URLSearchParams(window.location.search);
  const universityId = params.get("university");

  const grid = document.getElementById("coursesGrid");
  const loader = document.getElementById("loader");
  const pagination = document.getElementById("pagination");
  const searchInput = document.getElementById("searchInput");
  const pageTitle = document.getElementById("pageTitle");

  const addBtn = document.getElementById("addCourseBtn");
  const modal = new bootstrap.Modal(document.getElementById("courseModal"));
  const saveBtn = document.getElementById("saveCourseBtn");

  const nameInput = document.getElementById("courseName");
  const curriculumType = document.getElementById("curriculumType");
  const durationInput = document.getElementById("duration");
  const durationUnit = document.getElementById("durationUnit");

  let editingId = null;
  let currentPage = 1;
  let currentSearch = "";
  let searchTimeout = null;

  // ================= ADMIN BUTTON =================
  if (isAdmin == "true") {
    addBtn.classList.remove("d-none");

    addBtn.addEventListener("click", () => {
      editingId = null;
      nameInput.value = "";
      durationInput.value = "";
      modal.show();
    });
  }

  // ================= LOAD COURSES =================
  async function loadCourses(page = 1, search = "") {

    loader.classList.remove("d-none");
    grid.classList.add("d-none");
    grid.innerHTML = "";

    let url = `${API_BASE}?page=${page}&search=${search}`;

    if (universityId) {
      url += `&university=${universityId}`;
    }

    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const data = await res.json();

    renderCourses(data.results);
    renderPagination(data);

    loader.classList.add("d-none");
    grid.classList.remove("d-none");
  }

  // ================= RENDER =================
  function renderCourses(courses) {

    if (!courses.length) {
      grid.innerHTML =
        `<div class="col-12 text-center text-muted">
           No courses found.
         </div>`;
      return;
    }

    courses.forEach(course => {

      const adminButtons = isAdmin == "true" ? `
          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary"
              onclick="event.stopPropagation(); CourseApp.edit(${course.id},
                                          '${course.name}',
                                          '${course.curriculum_type}',
                                          ${course.duration},
                                          '${course.duration_unit}')">
              Edit
            </button>

            <button class="btn btn-sm btn-outline-danger"
              onclick="event.stopPropagation(); CourseApp.delete(${course.id})">
              Delete
            </button>
          </div>
        ` : "";


      grid.innerHTML += `
      <div class="col-md-4">
        <div class="browse-card p-4 h-100 shadow-sm rounded"
             style="cursor:pointer; transition:0.2s ease;"
             onclick="window.location.href='/periods/?course=${course.id}'"
             onmouseover="this.style.transform='translateY(-4px)'"
             onmouseout="this.style.transform='translateY(0)'">
    
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="mb-2">${course.name}</h5>
            <span class="badge bg-primary">
              ${course.curriculum_type}
            </span>
          </div>
    
          <p class="small auth-subtitle mb-3">
            ${course.duration} ${course.duration_unit}
          </p>
    
          <div class="text-end text-primary small">
            View Periods →
          </div>
    
          ${adminButtons}
    
        </div>
      </div>
    `;
    
  }
    )
}

  // ================= PAGINATION =================
  function renderPagination(data) {
    pagination.innerHTML = "";
    const totalPages = Math.ceil(data.count / 10);

    for (let i = 1; i <= totalPages; i++) {
      pagination.innerHTML += `
        <li class="page-item ${i === currentPage ? "active" : ""}">
          <a class="page-link"
             href="#"
             onclick="CourseApp.goToPage(${i})">${i}</a>
        </li>
      `;
    }
  }

  // ================= SEARCH =================
  searchInput.addEventListener("input", (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      currentSearch = e.target.value.trim();
      currentPage = 1;
      loadCourses(currentPage, currentSearch);
    }, 400);
  });

  // ================= SAVE =================
  saveBtn.addEventListener("click", async () => {
    UI.setLoading(saveBtn, "Saving...");
    
  //saveBtn.disabled = true;
  //const originalText = saveBtn.innerHTML;

  saveBtn.innerHTML = `
    <span class="spinner-border spinner-border-sm me-2"></span>
    Saving...
  `;


    const payload = {
      name: nameInput.value,
      curriculum_type: curriculumType.value,
      duration: durationInput.value,
      duration_unit: durationUnit.value,
      university: universityId
    };

    let url = API_BASE;
    let method = "POST";

    if (editingId) {
      url += `${editingId}/`;
      method = "PUT";
    }

    const res = await fetch(url, {
      method,
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify(payload)
    });
    UI.clearLoading(saveBtn);

    if (res.ok) {
      modal.hide();
      loadCourses(currentPage, currentSearch);
    }
    
  // Restore button
 // saveBtn.disabled = false;
  //saveBtn.innerHTML = originalText;
  
  UI.showToast("Course saved");
  });

  // ================= PUBLIC METHODS =================
  window.CourseApp = {

    edit(id, name, curriculum, duration, unit) {
      editingId = id;
      nameInput.value = name;
      curriculumType.value = curriculum;
      durationInput.value = duration;
      durationUnit.value = unit;
      modal.show();
    },

    async delete(id) {
      if (!confirm("Delete this course?")) return;

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = `
        <span class="spinner-border spinner-border-sm"></span>
      `;
    

      await fetch(`${API_BASE}${id}/`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` }
      });

      loadCourses(currentPage, currentSearch);
    },

    goToPage(page) {
      currentPage = page;
      loadCourses(currentPage, currentSearch);
    }

  };

  loadCourses();

})();
</script>

{% endblock %}




{% comment %} {% extends 'website/base.html' %}
{% block content %}

<h4>Courses</h4>
<div class="row g-4" id="list"></div>

<script>
fetch(`/api/courses/{{university_id}}/`)
.then(r=>r.json())
.then(data=>{
let html=""
data.forEach(c=>{
html+=`
<div class="col-md-3">
 <a href="/books/${c.id}/">
  <div class="edu-card">${c.name}</div>
 </a>
</div>
`
})
document.getElementById("list").innerHTML=html
})
</script>

{% endblock %} {% endcomment %}
